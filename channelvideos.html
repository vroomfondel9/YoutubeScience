<html>
	<head>
		<title>Youtube Science</title>
		<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js@next"></script>
		<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@next"></script>
		<script type="text/javascript">
		
			// YOUTUBE
		
			function getAllVideosForChannel(channelId) {
				getAllVideosForChannelInternal(channelId, '', [], videoIdsForChannelComplete);
			}
		
			function getAllVideosForChannelInternal(channelId, pageToken, ongoingResults, onCompleteCallback) 
			{
				$.ajax({
					type: 'GET',
					url: 'https://www.googleapis.com/youtube/v3/search',
					data: {
						key: 'AIzaSyBuUqltdabKn2nxyJNJYWsAyrcllzW4z58',
						channelId: channelId,
						part: 'id',
						order: 'date',
						maxResults: 50,
						pageToken: pageToken,
						type: 'video'
					},
					success: function(data){
						for (var i = 0; i < data.items.length; i++) {
							ongoingResults.push(data.items[i].id.videoId);
						}
						
						var nextPageToken = data.nextPageToken;
						
						if (!nextPageToken) {
							onCompleteCallback(ongoingResults);
						}
						else {
							getAllVideosForChannelInternal(channelId, nextPageToken, ongoingResults, onCompleteCallback);
						}
					},
					error: function(response){
						console.error("Error on call " + (Math.floor(ongoingResults.length / 50) + 1) + " to search for videos by keyword.");
						console.error(response.responseJSON.error.message);
					}
				});
			}
			
			function videoIdsForChannelComplete(results) {
				// TODO hook up videos
				console.log("Found " + results.length + " results for channel:");
				console.log(results);
			}
		
			function getVideoIdsByKeyword(keyword, maxResults, channelVideoIds) {
				var encodedQuery = encodeURI(keyword);
				getVideoIdsByKeywordInternal(encodedQuery, maxResults, '', [], singleSearchComplete, channelVideoIds);
			}
		
			function getVideoIdsByKeywordInternal(keyword, maxResults, pageToken, ongoingResults, onCompleteCallback, channelVideoIds) 
			{
				$.ajax({
					type: 'GET',
					url: 'https://www.googleapis.com/youtube/v3/search',
					data: {
						key: 'AIzaSyBuUqltdabKn2nxyJNJYWsAyrcllzW4z58',
						q: keyword,
						part: 'id',
						maxResults: 50,
						pageToken: pageToken,
						type: 'video'
					},
					success: function(data){
						for (var i = 0; i < data.items.length; i++) {
							ongoingResults.push(data.items[i].id.videoId);
						}
						
						var nextPageToken = data.nextPageToken;
						
						if ((ongoingResults.length >= maxResults) || (!nextPageToken)) {
							onCompleteCallback(ongoingResults, maxResults, "keyword", channelVideoIds, keyword);
						}
						else {
							getVideoIdsByKeywordInternal(keyword, maxResults, nextPageToken, ongoingResults, onCompleteCallback, channelVideoIds);
						}
					},
					error: function(response){
						console.error("Error on call " + (Math.floor(ongoingResults.length / 50) + 1) + " to search for videos by keyword.");
						console.error(response.responseJSON.error.message);
					}
				});
			}
			
			function getVideoIdsByRelatedVideoId(relatedVideoId, maxResults, channelVideoIds) {
				getVideoIdsByRelatedVideoIdInternal(relatedVideoId, maxResults, '', [], singleSearchComplete, channelVideoIds);
			}
		
			function getVideoIdsByRelatedVideoIdInternal(relatedVideoId, maxResults, pageToken, ongoingResults, onCompleteCallback, channelVideoIds) 
			{
				$.ajax({
					type: 'GET',
					url: 'https://www.googleapis.com/youtube/v3/search',
					data: {
						key: 'AIzaSyBuUqltdabKn2nxyJNJYWsAyrcllzW4z58',
						relatedToVideoId: relatedVideoId,
						part: 'id',
						maxResults: 50,
						pageToken: pageToken,
						type: 'video'
					},
					success: function(data){
						for (var i = 0; i < data.items.length; i++) {
							ongoingResults.push(data.items[i].id.videoId);
						}
						
						var nextPageToken = data.nextPageToken;
						
						if ((ongoingResults.length >= maxResults) || (!nextPageToken)) {
							onCompleteCallback(ongoingResults, maxResults, "related", channelVideoIds, relatedVideoId);
						}
						else {
							getVideoIdsByRelatedVideoIdInternal(relatedVideoId, maxResults, nextPageToken, ongoingResults, onCompleteCallback, channelVideoIds);
						}
					},
					error: function(response){
						console.error("Error on call " + (Math.floor(ongoingResults.length / 50) + 1) + " to search for videos by related video.");
						console.error(response.responseJSON.error.message);
					}
				});
			}
			
			function singleSearchComplete(results, maxResults, type, channelVideoIds, context) {
				// TODO types may be "related" or "keyword"
				// TODO results.length may not equal maxResults
				console.log("Found " + results.length + "/" + maxResults + " results for search by " + type + " for context" + context + ":");
				console.log(results);
			}
			
			// YOUTUBE -> HEATMAP TRANSFORMATIONS
			
			//TODO delete
			function getTestData() {
				var videoIds = [
				  "lML4i0BXASs",
				  "gkT2LUYJXLE",
				  "8-HlwY6SLeI",
				  "eIjNrq5bzEI",
				  "g974HQa_KmM",
				  "eisgDzcAIW8",
				  "i-s08yPS1fg",
				  "miHNQqnObWE",
				  "GI0YrbYyWcw",
				  "tPTL_rHQpzU",
				  "5YA-bHjCmhc",
				  "21YiJA5e3d0",
				  "peLGak1m-T8",
				  "UW0fyG1o_Oc",
				  "WmlzTg8kF9I",
				  "GuiPFDHXX_M",
				  "Z8ScIyTrMY4",
				  "BbTaP9ty0Yk",
				  "IDY9JakQYHo",
				  "LYP8t9_O-AM",
				  "qs2ngyJ3y48",
				  "Ry7MEz384dU",
				  "GB1BkptBr9w"
				];
				var testData = [];
				
				for (var i = 0; i < videoIds.length; i++) {
					var rand = Math.floor(Math.random() * 5);
					for (var j = 0; j < rand; j++) {
						testData.push("Fake");
					}
					testData.push(videoIds[i]);
				}
				
				return testData;
			}
			
		// HEATMAP
		
		var ctx = document.getElementById("chart-area").getContext("2d");
			window.myMatrix = new Chart(ctx, {
				type: 'matrix',
				data: {
					datasets: [{
						label: 'My Matrix',
						data: [
							{x: 'A', y: 'X', v: 11},
							{x: 'A', y: 'Y', v: 12},
							{x: 'A', y: 'Z', v: 13},
							{x: 'B', y: 'X', v: 21},
							{x: 'B', y: 'Y', v: 22},
							{x: 'B', y: 'Z', v: 23},
							{x: 'C', y: 'X', v: 31},
							{x: 'C', y: 'Y', v: 32},
							{x: 'C', y: 'Z', v: 33}
						],
						backgroundColor(context) {
							const value = context.dataset.data[context.dataIndex].v;
							const alpha = (value - 5) / 40;
							return Chart.helpers.color('green').alpha(alpha).rgbString();
						},
						width(context) {
							const a = context.chart.chartArea;
							if (!a) {
								return 0;
							}
							return (a.right - a.left) / 3 - 2;
						},
						height(context) {
							const a = context.chart.chartArea;
							if (!a) {
								return 0;
							}
							return (a.bottom - a.top) / 3 - 2;
						}
					}]
				},
				options: {
					legend: {
						display: false
					},
					tooltips: {
						callbacks: {
							title() {
								return '';
							},
							label(context) {
								const v = context.dataset.data[context.dataIndex];
								return ['x: ' + v.x, 'y: ' + v.y, 'v: ' + v.v];
							}
						}
					},
					scales: {
						x: {
							type: 'category',
							labels: ['A', 'B', 'C'],
							ticks: {
								display: true
							},
							gridLines: {
								display: false
							}
						},
						y: {
							type: 'category',
							labels: ['X', 'Y', 'Z'],
							offset: true,
              reverse: false,
							ticks: {
								display: true
							},
							gridLines: {
								display: false
							}
						}
					}
				}
			});
		</script>
	</head>
	<body>
		<h1>This is a test</h1>
		<div id="canvas-holder">
		  <canvas id="chart-area" width="400" height="100"></canvas>
		</div>
		<script type="text/javascript">
			//getVideoIdsByKeyword('video games', 50);
			console.log(getTestData());
		</script>
	</body>
</html>